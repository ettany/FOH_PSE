<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .chart-container {
            margin-top: 20px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            background: #fff;
            border: 1px solid #ccc;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .dot {
            stroke: #000;
            stroke-width: 0.5px;
        }
    </style>
</head>
<body>
    {% include 'header.html' %}
    <main>
        <div id="portfolio">
            <h1>Welcome, <span id="username"></span>!</h1>
            <div id="balance">
                <table>
                    <tbody>
                        <th>Current Balance</th>
                        <tr>
                            <td>$<span id="totalCash"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <section>
            <div id="stocks_owned">
                <table>
                    <thead>
                        <tr>
                            <th>Stocks Owned</th>
                            <th>Change %</th>
                            <th>Profit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic table rows go here -->
                    </tbody>
                </table>
            </div>
            <div id="stocks-chart" class="chart-container">
                <svg width="600" height="400">
                    <g transform="translate(60,20)">
                        <g class="x-axis"></g>
                        <g class="y-axis"></g>
                    </g>
                </svg>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 Fox Of Hood</p>
    </footer>

    <script type="module">
        import { drawScatterPlotChart } from "{{ url_for('static', filename='utils/chartUtils.js') }}";

        // Fetch user data and update portfolio
        async function fetchUserData() {
            const sessionDataString = sessionStorage.getItem("session");

            if (sessionDataString) {
                const sessionData = JSON.parse(sessionDataString);
                const username = sessionData.username || "Guest";

                const response = await fetch("http://127.0.0.1:5000/api/user/index", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username })
                });

                const result = await response.json();
                const totalCash = result.totalCash;
                document.getElementById("username").textContent = username || "Guest";
                document.getElementById("totalCash").textContent = totalCash || "0.00";
            }
        }

        // Fetch and update portfolio table and chart
        async function fetchPortfolio() {
            try {
                const response = await fetch("http://127.0.0.1:5000/api/transaction/portfolio", {
                    method: "GET",
                    credentials: "include",
                });

                if (!response.ok) throw new Error("Error fetching portfolio data");

                const data = await response.json();

                // Update table
                const stocksTableBody = document.querySelector("#stocks_owned tbody");
                stocksTableBody.innerHTML = ""; // Clear existing rows

                const formattedData = data.map(stock => {
                    const row = document.createElement("tr");

                    // Create table cells
                    const stockCell = document.createElement("td");
                    stockCell.textContent = `${stock.ticker} (${stock.numShares} shares)`;

                    const changeCell = document.createElement("td");
                    changeCell.textContent = `${stock.price_change_percent.toFixed(2)}%`;
                    changeCell.style.color = stock.price_change_percent >= 0 ? "green" : "red";

                    const profitCell = document.createElement("td");
                    profitCell.textContent = `$${stock.price_change.toFixed(2)}`;
                    profitCell.style.color = stock.price_change >= 0 ? "green" : "red";

                    // Append cells to the row
                    row.appendChild(stockCell);
                    row.appendChild(changeCell);
                    row.appendChild(profitCell);

                    // Append the row to the table body
                    stocksTableBody.appendChild(row);

                    // Format data for the chart
                    return {
                        stock: stock.ticker,
                        change: stock.price_change_percent,
                        profit: stock.price_change,
                    };
                });

                // Update the D3 chart
                drawScatterPlotChart(formattedData);
            } catch (error) {
                console.error("Error fetching portfolio:", error);
                alert("Failed to load portfolio. Please try again.");
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserData();
            fetchPortfolio();
            setInterval(fetchPortfolio, 3000);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .chart-container {
            margin-top: 20px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            background: #fff;
            border: 1px solid #ccc;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .dot {
            stroke: #000;
            stroke-width: 0.5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="topnav">
            <div class="pages">
                <a class="active" href="{{ url_for('index') }}">Portfolio</a>
                <a href="{{ url_for('trade') }}">Trade</a>
                <a href="{{ url_for('log') }}">Log</a>
                <a href="{{ url_for('visualization') }}">Visualization</a>
            </div>
            <div class="logout">
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </header>
    <main>
        <div id="portfolio">
            <h1>Welcome, <span id="username"></span>!</h1>
            <div id="balance">
                <table>
                    <tbody>
                        <th>Current Balance</th>
                        <tr>
                            <td>$<span id="totalCash"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <section>
            <div id="stocks_owned">
                <table>
                    <thead>
                        <tr>
                            <th>Stocks Owned</th>
                            <th>Change %</th>
                            <th>Profit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic table rows go here -->
                    </tbody>
                </table>
            </div>
            <div id="stocks-chart" class="chart-container">
                <svg width="600" height="400">
                    <g transform="translate(60,20)">
                        <g class="x-axis"></g>
                        <g class="y-axis"></g>
                    </g>
                </svg>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 Fox Of Hood</p>
    </footer>

    <script>
        // Fetch user data and update portfolio
        async function fetchUserData() {
            const sessionDataString = sessionStorage.getItem("session");

            if (sessionDataString) {
                const sessionData = JSON.parse(sessionDataString);
                const username = sessionData.username || "Guest";

                const response = await fetch("http://127.0.0.1:5000/api/user/index", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username })
                });

                const result = await response.json();
                const totalCash = result.totalCash;
                document.getElementById("username").textContent = username || "Guest";
                document.getElementById("totalCash").textContent = totalCash || "0.00";
            }
        }

        // Fetch and update portfolio table and chart
        async function fetchPortfolio() {
            try {
                const response = await fetch("http://127.0.0.1:5000/api/transaction/portfolio", {
                    method: "GET",
                    credentials: "include",
                });

                if (!response.ok) throw new Error("Error fetching portfolio data");

                const data = await response.json();

                // Update table
                const stocksTableBody = document.querySelector("#stocks_owned tbody");
                stocksTableBody.innerHTML = ""; // Clear existing rows

                const formattedData = data.map(stock => {
                    const row = document.createElement("tr");

                    // Create table cells
                    const stockCell = document.createElement("td");
                    stockCell.textContent = `${stock.ticker} (${stock.numShares} shares)`;

                    const changeCell = document.createElement("td");
                    changeCell.textContent = `${stock.price_change_percent.toFixed(2)}%`;
                    changeCell.style.color = stock.price_change_percent >= 0 ? "green" : "red";

                    const profitCell = document.createElement("td");
                    profitCell.textContent = `$${stock.price_change.toFixed(2)}`;
                    profitCell.style.color = stock.price_change >= 0 ? "green" : "red";

                    // Append cells to the row
                    row.appendChild(stockCell);
                    row.appendChild(changeCell);
                    row.appendChild(profitCell);

                    // Append the row to the table body
                    stocksTableBody.appendChild(row);

                    // Format data for the chart
                    return {
                        stock: stock.ticker,
                        change: stock.price_change_percent,
                        profit: stock.price_change,
                    };
                });

                // Update the D3 chart
                updateChart(formattedData);
            } catch (error) {
                console.error("Error fetching portfolio:", error);
                alert("Failed to load portfolio. Please try again.");
            }
        }

        // Update the chart with new data
        function updateChart(data) {
            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select('#stocks-chart svg g');

            // Update scales
            const xPadding = (d3.max(data, d => d.change) - d3.min(data, d => d.change)) * 0.1;
            const yPadding = (d3.max(data, d => d.profit) - d3.min(data, d => d.profit)) * 0.1;

            const x = d3.scaleLinear()
                .domain([
                    Math.min(0, d3.min(data, d => d.change) - xPadding),
                    d3.max(data, d => d.change) + xPadding
                ])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([
                    d3.min(data, d => d.profit) - yPadding,
                    d3.max(data, d => d.profit) + yPadding
                ])
                .range([height, 0]);

            // Update axes
            svg.select('.x-axis')
                .attr('transform', `translate(0,${y(0)})`)
                .transition().duration(750)
                .call(d3.axisBottom(x).tickFormat(d => d + "%"));

            svg.select('.y-axis')
                .transition().duration(750)
                .call(d3.axisLeft(y).tickFormat(d => "$" + d));

            // Bind data and update dots
            const dots = svg.selectAll('.dot').data(data);

            // Enter
            dots.enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('r', 6)
                .merge(dots)
                .transition().duration(750)
                .attr('cx', d => x(d.change))
                .attr('cy', d => y(d.profit))
                .attr('fill', d => d.profit >= 0 ? 'steelblue' : 'red');

            // Exit
            dots.exit().remove();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserData();
            fetchPortfolio();
            setInterval(fetchPortfolio, 3000);
        });
    </script>
</body>
</html>

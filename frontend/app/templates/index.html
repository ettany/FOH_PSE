<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .chart-container {
            margin-top: 20px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            background: #fff;
            border: 1px solid #ccc;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .dot {
            stroke: #000;
            stroke-width: 0.5px;
        }
    </style>
</head>
<body>
    {% include 'header.html' %}
    <main>
        <div id="portfolio">
            <h1>Welcome, <span id="username"></span>!</h1>
            <div id="balance">
                <table>
                    <tbody>
                        <th>Current Balance</th>
                        <tr>
                            <td>$<span id="totalCash"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <section>
            <div id="stocks_owned">
                <table>
                    <thead>
                        <tr>
                            <th>Stocks Owned</th>
                            <th>Change %</th>
                            <th>Profit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Example stock 1</td>
                            <td>-0.05%</td>
                            <td>-$5.67</td>
                        </tr>
                        <tr>
                            <td>Example stock 2</td>
                            <td>+1.35%</td>
                            <td>+$5.20</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="stocks-chart" class="chart-container"></div>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 Fox Of Hood</p>
    </footer>

    <script type="module">
        import { drawScatterPlotChart } from "{{ url_for('static', filename='utils/chartUtils.js') }}";

        // Fetch user data and update portfolio
        async function fetchUserData() {
            const sessionDataString = sessionStorage.getItem("session");

            if (sessionDataString) {
                const sessionData = JSON.parse(sessionDataString);
                const username = sessionData.username || "Guest";

                const response = await fetch("http://127.0.0.1:5000/api/user/index", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username })
                });

                const result = await response.json();
                const totalCash = result.totalCash;
                document.getElementById("username").textContent = username || "Guest";
                document.getElementById("totalCash").textContent = totalCash || "0.00";
            }
        }

        // Fetch and update portfolio table and chart
        async function fetchPortfolio() {
            try {
                const response = await fetch("http://127.0.0.1:5000/api/transaction/portfolio", {
                    method: "GET",
                    credentials: "include",
                });

                if (!response.ok) throw new Error("Error fetching portfolio data");

                const data = await response.json();

                const stocksTableBody = document.querySelector("#stocks_owned tbody");
                stocksTableBody.innerHTML = ""; // Clear existing rows

                const scatterPlotData = data.map(stock => ({
                    change: ((stock.currentPrice - stock.purchasePrice) / stock.purchasePrice) * 100,
                    profit: stock.currentPrice - stock.purchasePrice
                }));

                drawScatterPlotChart(scatterPlotData);
                data.forEach(stock => {
                    const row = document.createElement("tr");

                    // Create table cells
                    const stockCell = document.createElement("td");
                    stockCell.textContent = `${stock.ticker} (${stock.numShares} shares)`;

                    const changeCell = document.createElement("td");
                    const currentPrice = stock.currentPrice;
                    const purchasePrice = stock.purchasePrice;

                    // Calculate the percentage change based on the purchase price
                    let price_change_percent = 0;
                    if (purchasePrice > 0) {
                        price_change_percent = ((currentPrice - purchasePrice) / purchasePrice) * 100;
                    }

                    changeCell.textContent = `${price_change_percent.toFixed(2)}%`;
                    changeCell.style.color = price_change_percent >= 0 ? "green" : "red";

                    const profitCell = document.createElement("td");
                    const price_change = currentPrice - purchasePrice;
                    profitCell.textContent = `$${price_change.toFixed(2)}`;
                    profitCell.style.color = price_change >= 0 ? "green" : "red";

                    // Append cells to the row
                    row.appendChild(stockCell);
                    row.appendChild(changeCell);
                    row.appendChild(profitCell);

                    // Append the row to the table body
                    stocksTableBody.appendChild(row);
                });

                
            } catch (error) {
                console.error("Error fetching portfolio:", error);
                alert("Failed to load portfolio. Please try again.");
            }
        }
        async function logout(event) {
                event.preventDefault();
                const redirectUrl = event.target.getAttribute('data-url');
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/user/logout', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message); // Show success message
                        window.location.href = "{{ url_for('logout') }}"; // Redirect to the homepage or login page
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.error}`); // Show error message
                    }
                } catch (error) {
                    console.error('Logout failed:', error);
                    alert('An unexpected error occurred. Please try again.');
                }
            }
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserData();
            fetchPortfolio();
            setInterval(fetchPortfolio, 3000);
        });
    </script>
</body>
</html>